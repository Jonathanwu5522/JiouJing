<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ä¹äº•å·¥æ¥­ï½œå®¢æˆ¶è¨‚å–®è¼¸å…¥ç³»çµ±</title>
<style>
:root{--bg:#0b1220;--card:#121b2e;--muted:#9fb0d0;--text:#eaf0ff;--line:#263554;}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI","Noto Sans TC",Arial;background:linear-gradient(180deg,#071022,#0b1220);color:var(--text)}
header{padding:16px;border-bottom:1px solid var(--line);position:sticky;top:0;background:rgba(11,18,32,.92);backdrop-filter:blur(6px);z-index:5}
h1{margin:0;font-size:18px}
.sub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.4}
main{max-width:1150px;margin:0 auto;padding:16px;display:grid;gap:14px}
.grid{display:grid;grid-template-columns:1fr;gap:14px}
@media(min-width:980px){.grid{grid-template-columns:1.25fr .75fr}}
.card{background:rgba(18,27,46,.9);border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.card h2{margin:0;padding:14px 14px 0;font-size:16px}
.content{padding:14px}
.row{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:720px){.row{grid-template-columns:1fr 1fr}}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #33456f;background:#0c1324;color:var(--text);outline:none}
input:focus,select:focus,textarea:focus{border-color:#4b6cff}
.inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid #33456f;background:#0c1324;font-size:13px}
.btn{cursor:pointer;border:1px solid #3a4f7f;background:#132044;color:var(--text);padding:10px 12px;border-radius:10px;font-weight:700}
.btn.primary{background:#1d3cff;border-color:#1d3cff}
.btn.danger{background:transparent;border-color:#b24a4a;color:#ffd6d6}
.btn.ok{background:rgba(37,195,107,.14);border-color:rgba(37,195,107,.5)}
.hint{color:var(--muted);font-size:12px;line-height:1.5}
.hr{height:1px;background:var(--line);margin:12px 0}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid var(--line);padding:8px 6px;font-size:12px;text-align:left;vertical-align:top}
th{color:var(--muted);font-weight:700}
.k{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;background:#0c1324;border:1px solid #33456f;color:var(--text);padding:10px 12px;border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,.35);display:none;max-width:92vw;z-index:99999}
.toast.show{display:block}
.readonly{opacity:.9}
.chk{display:flex;align-items:center;gap:8px;border:1px solid #33456f;background:#0c1324;border-radius:10px;padding:10px}
.chk input{width:auto}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid #33456f;background:#0c1324;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="inline" style="justify-content:space-between">
    <div>
      <h1>ä¹äº•å·¥æ¥­ï½œå®¢æˆ¶è¨‚å–®è¼¸å…¥ç³»çµ±</h1>
      <div class="sub">è³‡æ–™å­˜æ”¾æ–¼æœ¬æ©Ÿç€è¦½å™¨ï¼ˆ<span class="k">ninewell_orders_v13</span>ï¼‰ã€‚</div>
    </div>
    <div class="inline">
      <a class="btn" href="./index.html" style="text-decoration:none;display:inline-flex;align-items:center;color:var(--text)">å›ä¸»é </a>
      <a class="btn primary" href="./index2.html" style="text-decoration:none;display:inline-flex;align-items:center;color:var(--text)">å»æŸ¥è©¢ç³»çµ±</a>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <h2>è¼¸å…¥è¨‚å–®</h2>
      <div class="content">
        <div class="inline" style="justify-content:space-between">
          <div class="pill"><strong>ç•¶ç­†è¨‚å–®è™Ÿ</strong> <span id="currentOrderNo" class="k">ï¼ˆè«‹æŒ‰æ–°å¢ / æˆ–ç›´æ¥è¼¸å…¥ä»»ä¸€æ¬„ä½ï¼‰</span></div>
          <div class="inline">
            <button class="btn ok" id="btnNew" type="button">æ–°å¢</button>
            <button class="btn" id="btnResetForm" type="button">æ¸…ç©ºè¡¨å–®</button>
            <button class="btn danger" id="btnAbandon" type="button">æ”¾æ£„å„²å­˜</button>
            <button class="btn primary" id="btnSave" type="button">å„²å­˜ï¼ˆæ–°å¢/æ›´æ–°ï¼‰</button>
          </div>
        </div>

        <div class="hr"></div>
        <h3 style="margin:0 0 8px;font-size:14px">åŸºæœ¬è³‡æ–™</h3>
        <div class="row">
          <div><label>é€²è²¨æ—¥æœŸ</label>
            <div style="display:flex;gap:8px;align-items:center">
              <input id="in_date" type="text" readonly placeholder="YYYY-MM-DD" style="flex:1"/>
              <button class="btn" type="button" data-date-btn="in_date">ğŸ“…</button>
            </div>
          </div>

          <div>
            <label>é è¨‚å‡ºè²¨æ—¥æœŸï¼ˆè‡ªå‹•/æ‰‹å‹•çš†å¯ï¼‰</label>
            <div style="display:flex;gap:8px;align-items:center">
              <input id="ship_due_date" type="text" readonly placeholder="YYYY-MM-DD" style="flex:1"/>
              <button class="btn" type="button" data-date-btn="ship_due_date">ğŸ“…</button>
              <button class="btn" id="btnShipDueAuto" type="button" title="å›è‡ªå‹•è¨ˆç®—">â†» å›è‡ªå‹•</button>
            </div>
            <div class="inline" style="margin-top:6px;justify-content:space-between">
              <div class="hint">è‡ªå‹•è¦å‰‡ï¼šA+2å¤© / B+3å¤© / C+4å¤© / D+5å¤©</div>
              <div class="badge">æ¨¡å¼ï¼š<span id="shipMode">è‡ªå‹•</span></div>
            </div>
          </div>

          <div><label>ç´šåˆ¥</label>
            <select id="level">
              <option value="">ï¼ˆç©ºç™½ï¼‰</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
            </select>
            <div class="hint" style="margin-top:6px">è‹¥ä½ æ‰‹å‹•é¸äº†é è¨‚å‡ºè²¨æ—¥æœŸï¼Œç³»çµ±ä¸æœƒè¦†è“‹ï¼ˆå¯æŒ‰ã€Œå›è‡ªå‹•ã€æ¢å¾©ï¼‰</div>
          </div>

          <div><label>å€åŸŸ</label>
            <select id="region">
              <option value="">ï¼ˆç©ºç™½ï¼‰</option>
              <option value="ä¸­éƒ¨åŒ—å€">ä¸­éƒ¨åŒ—å€</option>
              <option value="ä¸­éƒ¨ä¸­å€">ä¸­éƒ¨ä¸­å€</option>
              <option value="ä¸­éƒ¨å—å€">ä¸­éƒ¨å—å€</option>
              <option value="åŒ—éƒ¨">åŒ—éƒ¨</option>
              <option value="å—éƒ¨">å—éƒ¨</option>
              <option value="è‡ªå–">è‡ªå–</option>
            </select>
          </div>

          <div><label>å®¢æˆ¶ *</label><input id="customer" placeholder="è«‹è¼¸å…¥å®¢æˆ¶"></div>
          <div><label>å“å *</label><input id="product" placeholder="è«‹è¼¸å…¥å“å"></div>
          <div><label>æè³ª</label><input id="material" placeholder="è«‹è¼¸å…¥æè³ª"></div>
          <div><label>æ•¸é‡</label><input id="qty" type="number" step="1" placeholder="è«‹è¼¸å…¥æ•¸é‡"></div>
          <div><label>é‡é‡</label><input id="weight" placeholder="ä¾‹å¦‚ï¼š12.5"></div>

          <div><label>åŒ…è£åˆ¥</label><input id="pack_type" placeholder="è«‹è¼¸å…¥åŒ…è£åˆ¥"></div>
          <div>
            <label>æ²¾æ²¹</label>
            <div class="chk">
              <input id="oil" type="checkbox"/>
              <span class="hint">å‹¾é¸ä»£è¡¨ã€Œæ²¾æ²¹ã€</span>
            </div>
          </div>

          <div style="grid-column:1/-1"><label>æ³¨æ„äº‹é …</label>
            <textarea id="notes" maxlength="100" placeholder="æœ€å¤š 100 å­—"
              style="width:100%;min-height:92px;padding:10px;border-radius:10px;border:1px solid #33456f;background:#0c1324;color:var(--text);outline:none;resize:vertical"></textarea>
            <div class="hint" style="margin-top:6px">æœ€å¤š 100 å­—</div>
          </div>
        </div>

        <div class="hr"></div>
        <h3 style="margin:0 0 8px;font-size:14px">è£½ç¨‹</h3>
        <div class="row">
          <div><label>æ’çˆå‹å¼</label><input id="schedule_type" placeholder="è«‹è¼¸å…¥æ’çˆå‹å¼"></div>
          <div><label>é ç†±æ™‚é–“(åˆ†)</label><input id="preheat_min" placeholder="ä¾‹å¦‚ï¼š30"></div>

          <div><label>å†·å»æ–¹å¼</label>
            <select id="cooling">
              <option value="">ï¼ˆç©ºç™½ï¼‰</option>
              <option value="ç„¡">ç„¡</option>
              <option value="æ²¹">æ²¹</option>
              <option value="æ°´">æ°´</option>
            </select>
          </div>

          <div><label>TF1æ™‚é–“(åˆ†)</label><input id="tf1_min" placeholder="ä¾‹å¦‚ï¼š60"></div>
          <div><label>TF1æº«åº¦(C)</label><input id="tf1_c" placeholder="ä¾‹å¦‚ï¼š570"></div>

          <div><label>AB1æ™‚é–“(åˆ†)</label><input id="ab1_min" placeholder="ä¾‹å¦‚ï¼š90"></div>
          <div><label>AB1æº«åº¦(C)</label><input id="ab1_c" placeholder="ä¾‹å¦‚ï¼š580"></div>

          <div><label>æ‹†çˆå‹å¼</label><input id="unload_type" placeholder="è«‹è¼¸å…¥æ‹†çˆå‹å¼"></div>
          <div><label>å¾Œè™•ç†</label><input id="post_process" placeholder="è«‹è¼¸å…¥å¾Œè™•ç†"></div>

          <div><label>AB2æ™‚é–“(åˆ†)</label><input id="ab2_min" placeholder="ä¾‹å¦‚ï¼š60"></div>
          <div><label>AB2æº«åº¦(C)</label><input id="ab2_c" placeholder="ä¾‹å¦‚ï¼š530"></div>
        </div>

        <div class="hr"></div>
        <h3 style="margin:0 0 8px;font-size:14px">å“è³ªè¦æ±‚</h3>
        <div class="row">
          <div><label>ç¡¬åº¦</label><input id="hardness" placeholder="è«‹è¼¸å…¥ç¡¬åº¦"></div>
          <div><label>åŒ–åˆå±¤</label><input id="compound_layer" placeholder="è«‹è¼¸å…¥åŒ–åˆå±¤"></div>
          <div><label>ç²—åº¦</label><input id="roughness" placeholder="è«‹è¼¸å…¥ç²—åº¦"></div>
          <div><label>é¹½éœ§</label><input id="salt_spray" placeholder="è«‹è¼¸å…¥é¹½éœ§"></div>
        </div>

        <div class="hr"></div>
        <h3 style="margin:0 0 8px;font-size:14px">å•†å‹™</h3>
        <div class="row">
          <div><label>Price</label><input id="price" placeholder="è«‹è¼¸å…¥ Price"></div>
        </div>

        <div class="hint" style="margin-top:10px">
          * å¿…å¡«ï¼šå®¢æˆ¶ã€å“åã€‚<br/>
          ä½ å¯ä»¥ä¸æŒ‰ã€Œæ–°å¢ã€ç›´æ¥å¡«è³‡æ–™ï¼Œç³»çµ±æœƒåœ¨ä½ ç¬¬ä¸€æ¬¡è¼¸å…¥æ™‚è‡ªå‹•ç”¢ç”Ÿè¨‚å–®è™Ÿã€‚
        </div>
      </div>
    </section>

    <aside class="card">
      <h2>CSV</h2>
      <div class="content">
        <div class="inline">
          <button class="btn danger" id="btnLoadNewCsv" type="button">è¼‰å…¥æ–° CSVï¼ˆè¦†è“‹æœ¬æ©Ÿï¼‰</button>
          <button class="btn ok" id="btnImportCsv" type="button">åŒ¯å…¥ CSVï¼ˆåˆä½µï¼‰</button>
          <input id="csvFileInput" type="file" accept=".csv,text/csv" style="display:none"/>
          <input id="csvFileInputNew" type="file" accept=".csv,text/csv" style="display:none"/>
        </div>
        <div class="hint" style="margin-top:8px">è¦†è“‹ï¼æ¸…ç©ºèˆŠè³‡æ–™å†è¼‰å…¥ï¼›åˆä½µï¼ä»¥ order_no å»é‡å¾ŒåŠ å…¥ã€‚</div>

        <div class="hr"></div>

        <div class="inline" style="justify-content:space-between">
          <div class="pill"><strong>å·²å„²å­˜</strong> <span id="countOrders" class="k">0</span> <span class="hint">ç­†</span></div>
          <div class="inline">
            <button class="btn" id="btnExportCsvNew" type="button">åŒ¯å‡ºåˆ°æ–° CSVï¼ˆä¸‹è¼‰ï¼‰</button>
            <button class="btn ok" id="btnExportCsvOverwrite" type="button">åŒ¯å‡ºåˆ°åŸæœ¬ CSVï¼ˆè¦†è“‹ï¼‰</button>
            <button class="btn danger" id="btnClearAll" type="button">æ¸…ç©ºæœ¬æ©Ÿè³‡æ–™</button>
          </div>
        </div>

        <div class="hint" style="margin-top:8px">
          ã€Œè¦†è“‹ã€éœ€ Edge/Chrome æ”¯æ´ File System Access APIã€‚è‹¥ä¸æ”¯æ´ï¼Œè«‹ç”¨ã€ŒåŒ¯å‡ºåˆ°æ–° CSVã€ã€‚
        </div>

        <div class="hr"></div>

        <h3 style="margin:0 0 8px;font-size:14px">æœ€è¿‘ 10 ç­†ï¼ˆå¯ä¿®æ”¹/åˆªé™¤ï¼‰</h3>
        <div style="overflow:auto;max-height:420px">
          <table>
            <thead><tr>
              <th>è¨‚å–®è™Ÿ</th><th>å€åŸŸ</th><th>å®¢æˆ¶</th><th>å“å</th><th class="k">é€²è²¨</th><th class="k">é è¨‚å‡ºè²¨</th><th>æ“ä½œ</th>
            </tr></thead>
            <tbody id="recentBody"></tbody>
          </table>
        </div>
      </div>
    </aside>
  </div>
</main>

<div class="toast" id="toast"></div>

<!-- å–®ä¸€æœˆæ›† -->
<div id="datePickerModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:9999">
  <div style="width:min(360px,92vw);background:#0c1324;border:1px solid #33456f;border-radius:14px;box-shadow:0 12px 30px rgba(0,0,0,.4);padding:12px">
    <div class="inline" style="justify-content:space-between">
      <button class="btn" id="dpPrev" type="button">ï¼œ</button>
      <div class="k" id="dpTitle" style="font-weight:800"></div>
      <button class="btn" id="dpNext" type="button">ï¼</button>
    </div>
    <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:10px;color:var(--muted);font-size:12px;text-align:center">
      <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
    </div>
    <div id="dpGrid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:8px"></div>
    <div class="inline" style="justify-content:flex-end;margin-top:12px">
      <button class="btn" id="dpClear" type="button">æ¸…ç©º</button>
      <button class="btn danger" id="dpClose" type="button">é—œé–‰</button>
    </div>
  </div>
</div>

<script>
/* =======================
   Storage / Schema
======================= */
var STORAGE_KEY="ninewell_orders_v13";
var COUNTER_KEY_PREFIX="ninewell_order_counter_";

var HEADERS=[
 "é€²è²¨æ—¥æœŸ","é è¨‚å‡ºè²¨æ—¥æœŸ","ç´šåˆ¥","å€åŸŸ","å®¢æˆ¶","å“å","æè³ª","æ•¸é‡","é‡é‡","åŒ…è£åˆ¥","æ²¾æ²¹","æ³¨æ„äº‹é …",
 "æ’çˆå‹å¼","é ç†±æ™‚é–“(åˆ†)","å†·å»æ–¹å¼",
 "TF1æ™‚é–“(åˆ†)","TF1æº«åº¦(C)",
 "AB1æ™‚é–“(åˆ†)","AB1æº«åº¦(C)",
 "æ‹†çˆå‹å¼","å¾Œè™•ç†",
 "AB2æ™‚é–“(åˆ†)","AB2æº«åº¦(C)",
 "ç¡¬åº¦","åŒ–åˆå±¤","ç²—åº¦","é¹½éœ§",
 "Price"
];

var ID_MAP={
 "é€²è²¨æ—¥æœŸ":"in_date",
 "é è¨‚å‡ºè²¨æ—¥æœŸ":"ship_due_date",
 "ç´šåˆ¥":"level",
 "å€åŸŸ":"region",
 "å®¢æˆ¶":"customer",
 "å“å":"product",
 "æè³ª":"material",
 "æ•¸é‡":"qty",
 "é‡é‡":"weight",
 "åŒ…è£åˆ¥":"pack_type",
 "æ²¾æ²¹":"oil",
 "æ³¨æ„äº‹é …":"notes",
 "æ’çˆå‹å¼":"schedule_type","é ç†±æ™‚é–“(åˆ†)":"preheat_min","å†·å»æ–¹å¼":"cooling",
 "TF1æ™‚é–“(åˆ†)":"tf1_min","TF1æº«åº¦(C)":"tf1_c",
 "AB1æ™‚é–“(åˆ†)":"ab1_min","AB1æº«åº¦(C)":"ab1_c",
 "æ‹†çˆå‹å¼":"unload_type","å¾Œè™•ç†":"post_process",
 "AB2æ™‚é–“(åˆ†)":"ab2_min","AB2æº«åº¦(C)":"ab2_c",
 "ç¡¬åº¦":"hardness","åŒ–åˆå±¤":"compound_layer","ç²—åº¦":"roughness","é¹½éœ§":"salt_spray",
 "Price":"price"
};

var CSV_HEADERS=["order_no","created_at"].concat(HEADERS);

/* ç‹€æ…‹ */
var editingOrderNo=null;
var draftOrderNo=null;
let csvFileHandle = null;

/* âœ… æ–°å¢ï¼šé è¨‚å‡ºè²¨æ—¥æœŸæ‰‹å‹•/è‡ªå‹•æ¨¡å¼ */
var shipDueManual = false; // false=è‡ªå‹•ï¼Œtrue=æ‰‹å‹•é–å®š

function $(id){return document.getElementById(id);}

function toast(msg, ok){
  if(ok===undefined) ok=true;
  var el=$("toast");
  el.textContent=msg;
  el.style.borderColor= ok ? "rgba(37,195,107,.55)" : "rgba(255,91,91,.6)";
  el.classList.add("show");
  setTimeout(function(){el.classList.remove("show");}, 2400);
}

function pad(n,w){n=String(n);return n.length>=w?n:(new Array(w-n.length+1).join("0")+n);}

function getYYMMDD(){ var d=new Date(); return String(d.getFullYear()).slice(-2)+pad(d.getMonth()+1,2)+pad(d.getDate(),2); }

function nowTime(){
  var d=new Date();
  return d.getFullYear()+"-"+pad(d.getMonth()+1,2)+"-"+pad(d.getDate(),2)+" "+pad(d.getHours(),2)+":"+pad(d.getMinutes(),2)+":"+pad(d.getSeconds(),2);
}

function getOrders(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");}catch(e){return [];}}
function setOrders(list){localStorage.setItem(STORAGE_KEY, JSON.stringify(list));}

function setCurrentOrderNo(no){
  $("currentOrderNo").textContent=no||"ï¼ˆè«‹æŒ‰æ–°å¢ / æˆ–ç›´æ¥è¼¸å…¥ä»»ä¸€æ¬„ä½ï¼‰";
}

function setShipMode(){
  $("shipMode").textContent = shipDueManual ? "æ‰‹å‹•" : "è‡ªå‹•";
}

function validateRequired(){
  if(!$("customer").value.trim()) return "å®¢æˆ¶ ç‚ºå¿…å¡«";
  if(!$("product").value.trim()) return "å“å ç‚ºå¿…å¡«";
  return "";
}

/* =======================
   Order number counter
======================= */
function counterKeyFor(yymmdd){return COUNTER_KEY_PREFIX+yymmdd;}

function computeNextOrderNo(){
  var yymmdd=getYYMMDD();
  var key=counterKeyFor(yymmdd);
  var next=parseInt(localStorage.getItem(key)||"0",10)+1;
  return "O"+yymmdd+pad(next,4);
}

function reserveNextOrderNo(){
  draftOrderNo=computeNextOrderNo();
  setCurrentOrderNo(draftOrderNo);
}

function commitOrderNo(orderNo){
  var yymmdd=orderNo.slice(1,7);
  var seq=parseInt(orderNo.slice(7),10);
  var key=counterKeyFor(yymmdd);
  var cur=parseInt(localStorage.getItem(key)||"0",10);
  if(seq>cur) localStorage.setItem(key, String(seq));
}

function ensureDraftOnFirstInput(){
  if(editingOrderNo) return;
  if(draftOrderNo) return;
  reserveNextOrderNo();
  toast("å·²è‡ªå‹•ç”¢ç”Ÿè¨‚å–®è™Ÿï¼š" + draftOrderNo);
}

/* =======================
   Form I/O
======================= */
function clearForm(){
  Object.keys(ID_MAP).forEach(function(h){
    var id=ID_MAP[h];
    var el=$(id);
    if(!el) return;
    if(id==="oil") el.checked=false;
    else el.value="";
  });
  shipDueManual = false;   // æ¸…ç©ºæ™‚å›åˆ°è‡ªå‹•
  setShipMode();
  $("customer").focus();
  recalcShipDue();
}

function collectForm(){
  var obj={};
  HEADERS.forEach(function(h){
    var id=ID_MAP[h];
    var el=$(id);
    if(!el){obj[h]=""; return;}
    if(id==="oil") obj[h]= el.checked ? "æ˜¯" : "";
    else obj[h]= (el.value||"").trim();
  });
  return obj;
}

function loadOrderToForm(order){
  HEADERS.forEach(function(h){
    var id=ID_MAP[h];
    var el=$(id);
    if(!el) return;
    if(id==="oil") el.checked = String(order[h]||"").trim()==="æ˜¯";
    else el.value = order[h]!==undefined ? order[h] : "";
  });

  // è®€å–è³‡æ–™æ™‚ï¼šè‹¥æœ‰é è¨‚å‡ºè²¨æ—¥æœŸï¼Œé è¨­è¦–ç‚ºã€Œæ‰‹å‹•ã€ä»¥å…è¢«è‡ªå‹•è¦†è“‹
  shipDueManual = !!String(order["é è¨‚å‡ºè²¨æ—¥æœŸ"]||"").trim();
  setShipMode();

  // å¦‚æœæ˜¯è‡ªå‹•æ¨¡å¼æ‰è¨ˆç®—
  recalcShipDue();
}

/* =======================
   Ship due date: auto + manual override
======================= */
function parseYMD(s){
  s=String(s||"").trim();
  if(!/^\d{4}-\d{2}-\d{2}$/.test(s)) return null;
  var d=new Date(s+"T00:00:00");
  return isNaN(d.getTime()) ? null : d;
}
function fmtYMD(d){ return d.getFullYear()+"-"+pad(d.getMonth()+1,2)+"-"+pad(d.getDate(),2); }
function addDays(d, days){ var x=new Date(d.getTime()); x.setDate(x.getDate()+days); return x; }
function getLevelDays(level){
  if(level==="A") return 2;
  if(level==="B") return 3;
  if(level==="C") return 4;
  if(level==="D") return 5;
  return null;
}
function recalcShipDue(){
  setShipMode();
  if(shipDueManual) return; // âœ… æ‰‹å‹•å„ªå…ˆï¼Œä¸è¦†è“‹

  var inD=parseYMD($("in_date").value);
  var lvl=($("level").value||"").trim();
  var days=getLevelDays(lvl);
  if(!inD || days===null){ $("ship_due_date").value=""; return; }
  $("ship_due_date").value=fmtYMD(addDays(inD, days));
}

/* =======================
   CSV: encode / decode
======================= */
function csvEscape(v){
  if(v===null||v===undefined) return "";
  var s=String(v);
  if(/[",\n\r]/.test(s)) return '"'+s.replace(/"/g,'""')+'"';
  return s;
}
function ordersToCsv(orders){
  var lines=[CSV_HEADERS.join(",")];
  orders.forEach(function(o){
    var row=CSV_HEADERS.map(function(h){return csvEscape(o[h]!==undefined?o[h]:"");});
    lines.push(row.join(","));
  });
  return lines.join("\r\n");
}
function downloadCsv(filename, text){
  var blob=new Blob(["\ufeff"+text], {type:"text/csv;charset=utf-8"});
  var a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(function(){URL.revokeObjectURL(a.href); a.remove();},0);
}

function parseCsvRow(line){
  var out=[], cur="", inQ=false;
  for(var i=0;i<line.length;i++){
    var ch=line[i];
    if(inQ){
      if(ch==='"'){ if(line[i+1]==='"'){cur+='"'; i++;} else inQ=false; }
      else cur+=ch;
    }else{
      if(ch==='"') inQ=true;
      else if(ch===','){ out.push(cur); cur=""; }
      else cur+=ch;
    }
  }
  out.push(cur);
  return out;
}
function parseCsvText(text){
  var lines=text.split(/\r?\n/).filter(function(l){return l.trim()!=="";});
  if(lines.length===0) return [];
  var header=parseCsvRow(lines[0]).map(function(h){return h.replace(/^\ufeff/,"").trim();});
  var idx={}; header.forEach(function(h,i){idx[h]=i;});
  if(idx["order_no"]===undefined) return [];
  var out=[];
  for(var r=1;r<lines.length;r++){
    var cols=parseCsvRow(lines[r]);
    var orderNo=(cols[idx["order_no"]]||"").trim();
    if(!orderNo) continue;
    var obj={};
    obj["order_no"]=orderNo;
    obj["created_at"]= idx["created_at"]===undefined ? "" : (cols[idx["created_at"]]||"");
    HEADERS.forEach(function(h){
      var j=idx[h];
      obj[h]= (j===undefined) ? "" : (cols[j]||"");
    });
    out.push(obj);
  }
  return out;
}

function syncCountersFromOrders(orders){
  var maxByDate={};
  orders.forEach(function(o){
    var no=o.order_no||"";
    if(!/^O\d{10}$/.test(no)) return;
    var yymmdd=no.slice(1,7);
    var seq=parseInt(no.slice(7),10);
    if(!isFinite(seq)) return;
    if(!maxByDate[yymmdd]||seq>maxByDate[yymmdd]) maxByDate[yymmdd]=seq;
  });
  Object.keys(maxByDate).forEach(function(yymmdd){
    var key=counterKeyFor(yymmdd);
    var cur=parseInt(localStorage.getItem(key)||"0",10);
    if(maxByDate[yymmdd]>cur) localStorage.setItem(key, String(maxByDate[yymmdd]));
  });
}

/* =======================
   Export overwrite (File System Access API)
======================= */
async function exportCsvOverwrite(filenameHint, csvText) {
  if (!window.showSaveFilePicker) {
    toast("æ­¤ç€è¦½å™¨ä¸æ”¯æ´ã€Œè¦†è“‹å¯«å›åŸæª”ã€ã€‚è«‹æ”¹ç”¨ã€ŒåŒ¯å‡ºåˆ°æ–° CSVï¼ˆä¸‹è¼‰ï¼‰ã€", false);
    return;
  }
  try {
    if (!csvFileHandle) {
      csvFileHandle = await window.showSaveFilePicker({
        suggestedName: filenameHint,
        types: [{ description: "CSV", accept: { "text/csv": [".csv"] } }]
      });
    }
    const writable = await csvFileHandle.createWritable();
    await writable.write("\ufeff" + csvText);
    await writable.close();
    toast("å·²è¦†è“‹å¯«å…¥åŸæœ¬ CSV");
  } catch (e) {
    toast("å·²å–æ¶ˆè¦†è“‹åŒ¯å‡ºï¼ˆæˆ–ç„¡æ¬Šé™ï¼‰", false);
  }
}

/* =======================
   Sidebar (recent)
======================= */
function renderSidebar(){
  var orders=getOrders();
  $("countOrders").textContent=String(orders.length);
  var recent=orders.slice(-10).reverse();
  var tbody=$("recentBody");
  tbody.innerHTML="";
  recent.forEach(function(o){
    var id=o.order_no;
    var tr=document.createElement("tr");
    tr.innerHTML=
      '<td class="k">'+id+'</td>'+
      '<td>'+(o["å€åŸŸ"]||"")+'</td>'+
      '<td>'+(o["å®¢æˆ¶"]||"")+'</td>'+
      '<td>'+(o["å“å"]||"")+'</td>'+
      '<td class="k">'+(o["é€²è²¨æ—¥æœŸ"]||"")+'</td>'+
      '<td class="k">'+(o["é è¨‚å‡ºè²¨æ—¥æœŸ"]||"")+'</td>'+
      '<td>'+
        '<button class="btn" data-action="edit" data-id="'+id+'" type="button">ä¿®æ”¹</button> '+
        '<button class="btn danger" data-action="delete" data-id="'+id+'" type="button">åˆªé™¤</button>'+
      '</td>';
    tbody.appendChild(tr);
  });
}

/* =======================
   Buttons
======================= */
$("btnNew").addEventListener("click", function(){
  editingOrderNo=null;
  reserveNextOrderNo();
  clearForm();
  toast("å·²é€²å…¥æ–°å¢æ¨¡å¼ï¼ˆç•¶ç­†è¨‚å–®è™Ÿå·²é¡¯ç¤ºï¼‰");
});

$("btnResetForm").addEventListener("click", function(){
  ensureDraftOnFirstInput();
  clearForm();
});

$("btnAbandon").addEventListener("click", function(){
  var hasDraft = !!draftOrderNo;
  var isEditing = !!editingOrderNo;

  var hasAnyInput = false;
  Object.keys(ID_MAP).forEach(function(h){
    var id=ID_MAP[h];
    var el=$(id);
    if(!el) return;
    if(id==="oil"){ if(el.checked) hasAnyInput=true; return; }
    if(String(el.value||"").trim()!=="") hasAnyInput=true;
  });

  if(hasDraft || isEditing || hasAnyInput){
    var ok=confirm("ç¢ºå®šæ”¾æ£„å„²å­˜ä¸¦é›¢é–‹ï¼Ÿ\nï¼ˆæœ¬æ¬¡è¼¸å…¥ä¸æœƒå¯«å…¥è³‡æ–™ï¼‰");
    if(!ok) return;
  }

  draftOrderNo=null;
  editingOrderNo=null;
  setCurrentOrderNo(null);
  clearForm();
  window.location.href="./index.html";
});

$("btnSave").addEventListener("click", function(){
  var err=validateRequired();
  if(err){toast(err,false); return;}

  // è‹¥è‡ªå‹•æ¨¡å¼ï¼Œå…ˆç¢ºä¿å‡ºè²¨æ—¥æ˜¯ä¾è¦å‰‡æ›´æ–°åˆ°æœ€æ–°
  if(!shipDueManual) recalcShipDue();

  if(!draftOrderNo && !editingOrderNo) reserveNextOrderNo();

  var orders=getOrders();
  var form=collectForm();

  if(editingOrderNo){
    var idx=orders.findIndex(function(x){return x.order_no===editingOrderNo;});
    if(idx<0){toast("æ‰¾ä¸åˆ°è¦æ›´æ–°çš„è¨‚å–®",false); return;}
    Object.keys(form).forEach(function(k){orders[idx][k]=form[k];});
    setOrders(orders);
    renderSidebar();
    setCurrentOrderNo(editingOrderNo);
    toast("å·²æ›´æ–°ï¼š"+editingOrderNo);
    return;
  }

  var orderNo=draftOrderNo;
  if(!orderNo){toast("å°šæœªç”¢ç”Ÿè¨‚å–®è™Ÿ",false); return;}

  var existIdx = orders.findIndex(function(x){return x.order_no===orderNo;});
  if(existIdx >= 0){
    Object.keys(form).forEach(function(k){orders[existIdx][k]=form[k];});
    setOrders(orders);
    renderSidebar();
    setCurrentOrderNo(orderNo);
    toast("æ­¤è¨‚å–®è™Ÿå·²å­˜åœ¨ï¼Œå·²æ”¹ç‚ºæ›´æ–°ï¼š"+orderNo);
    draftOrderNo = null;
    return;
  }

  commitOrderNo(orderNo);

  var order={"order_no":orderNo,"created_at":nowTime()};
  Object.keys(form).forEach(function(k){order[k]=form[k];});

  orders.push(order);
  setOrders(orders);
  renderSidebar();
  setCurrentOrderNo(orderNo);
  toast("å·²æ–°å¢ä¸¦å„²å­˜ï¼š"+orderNo);

  draftOrderNo=null;
});

$("recentBody").addEventListener("click", function(e){
  var btn=e.target.closest("button"); if(!btn) return;
  var action=btn.getAttribute("data-action");
  var id=btn.getAttribute("data-id");
  var orders=getOrders();
  var idx=orders.findIndex(function(x){return x.order_no===id;});
  if(idx<0){toast("æ‰¾ä¸åˆ°è¨‚å–®ï¼š"+id,false); return;}

  if(action==="edit"){
    editingOrderNo=id;
    draftOrderNo=null;
    loadOrderToForm(orders[idx]);
    setCurrentOrderNo(id);
    toast("å·²è¼‰å…¥å¯ä¿®æ”¹ï¼š"+id);
  }else if(action==="delete"){
    var ok=confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ\n"+id+"\nï¼ˆä¸å¯å¾©åŸï¼‰");
    if(!ok) return;
    orders.splice(idx,1);
    setOrders(orders);
    renderSidebar();
    if(editingOrderNo===id){editingOrderNo=null; setCurrentOrderNo(null);}
    toast("å·²åˆªé™¤ï¼š"+id);
  }
});

$("btnExportCsvNew").addEventListener("click", function(){
  var orders=getOrders();
  if(orders.length===0){toast("ç›®å‰æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º",false); return;}
  downloadCsv("ninewell_orders_"+getYYMMDD()+".csv", ordersToCsv(orders));
  toast("å·²ä¸‹è¼‰æ–° CSV");
});

$("btnExportCsvOverwrite").addEventListener("click", async function(){
  var orders=getOrders();
  if(orders.length===0){toast("ç›®å‰æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º",false); return;}
  var csvText = ordersToCsv(orders);
  await exportCsvOverwrite("ninewell_orders.csv", csvText);
});

$("btnClearAll").addEventListener("click", function(){
  var ok=confirm("ç¢ºå®šè¦æ¸…ç©ºå…¨éƒ¨è³‡æ–™ï¼Ÿï¼ˆä¸å¯å¾©åŸï¼‰");
  if(!ok) return;
  localStorage.removeItem(STORAGE_KEY);
  renderSidebar();
  draftOrderNo=null; editingOrderNo=null;
  setCurrentOrderNo(null);
  clearForm();
  toast("å·²æ¸…ç©º");
});

/* å›è‡ªå‹•ï¼šè§£é™¤æ‰‹å‹•é–å®šï¼Œç«‹å³é‡ç®— */
$("btnShipDueAuto").addEventListener("click", function(){
  ensureDraftOnFirstInput();
  shipDueManual = false;
  setShipMode();
  recalcShipDue();
  toast("å·²åˆ‡å›è‡ªå‹•è¨ˆç®—");
});

/* =======================
   Import / Replace CSV
======================= */
$("btnImportCsv").addEventListener("click", function(){$("csvFileInput").click();});
$("btnLoadNewCsv").addEventListener("click", function(){$("csvFileInputNew").click();});

function importCsvTextIntoLocal(text, mode){
  var rows=parseCsvText(text);
  if(rows.length===0){toast("åŒ¯å…¥å¤±æ•—ï¼šæ²’æœ‰è®€åˆ°è³‡æ–™åˆ—ï¼ˆè«‹ç¢ºèª CSV å…§æœ‰ order_no æ¬„ä½ï¼‰", false); return;}

  if(mode==="replace"){
    setOrders(rows);
    syncCountersFromOrders(rows);
    renderSidebar();
    toast("å·²è¼‰å…¥æ–° CSVï¼ˆè¦†è“‹ï¼‰ï¼š" + rows.length + " ç­†");
    return;
  }

  var local=getOrders();
  var map={}; local.forEach(function(o){map[o.order_no]=o;});
  rows.forEach(function(o){ if(o.order_no && !map[o.order_no]) map[o.order_no]=o; });

  var merged=Object.values(map);
  setOrders(merged);
  syncCountersFromOrders(merged);
  renderSidebar();
  toast("å·²åŒ¯å…¥ä¸¦åˆä½µ " + rows.length + " ç­†ï¼›æœ¬æ©Ÿå…± " + merged.length + " ç­†");
}

$("csvFileInput").addEventListener("change", function(e){
  var file=e.target.files && e.target.files[0]; if(!file) return;
  var reader=new FileReader();
  reader.onload=function(){importCsvTextIntoLocal(String(reader.result||""), "merge");};
  reader.readAsText(file);
  e.target.value="";
});
$("csvFileInputNew").addEventListener("change", function(e){
  var file=e.target.files && e.target.files[0]; if(!file) return;
  var ok=confirm("æ­¤æ“ä½œæœƒç”¨æ–° CSV è¦†è“‹æœ¬æ©Ÿè³‡æ–™ï¼ˆä¸å¯å¾©åŸï¼‰ã€‚\nç¢ºå®šè¦è¼‰å…¥æ–° CSV å—ï¼Ÿ");
  if(!ok){e.target.value=""; return;}
  var reader=new FileReader();
  reader.onload=function(){importCsvTextIntoLocal(String(reader.result||""), "replace");};
  reader.readAsText(file);
  e.target.value="";
});

/* =======================
   Auto draft on first input
======================= */
(function bindAutoDraft(){
  var ids = Object.values(ID_MAP);
  ids.forEach(function(id){
    var el=$(id);
    if(!el) return;

    // ship_due_date / in_date ç”±æœˆæ›†é¸ï¼ˆåœ¨æœˆæ›†é¸åˆ°æ™‚æ‰è§¸ç™¼ï¼‰
    if(id==="ship_due_date" || id==="in_date") return;

    var evt = (el.tagName==="SELECT" || el.type==="checkbox") ? "change" : "input";
    el.addEventListener(evt, function(){
      ensureDraftOnFirstInput();
    });
  });
})();

/* é€²è²¨æ—¥/ç´šåˆ¥æ”¹è®Šï¼šè‹¥æ˜¯è‡ªå‹•æ¨¡å¼æ‰é‡ç®— */
$("level").addEventListener("change", function(){
  ensureDraftOnFirstInput();
  if(!shipDueManual) recalcShipDue();
});

/* =======================
   Calendar (single)
======================= */
var dpTargetId=null, dpYear=null, dpMonth=null;

function dpFmt(y,m,day){return y+"-"+pad(m+1,2)+"-"+pad(day,2);}

function dpOpen(targetId){
  dpTargetId=targetId;
  var v=($(targetId).value||"").trim();
  var d=/^\d{4}-\d{2}-\d{2}$/.test(v) ? new Date(v+"T00:00:00") : new Date();
  dpYear=d.getFullYear(); dpMonth=d.getMonth();
  dpRender();
  $("datePickerModal").style.display="flex";
}
function dpClose(){ $("datePickerModal").style.display="none"; dpTargetId=null; }

function dpRender(){
  $("dpTitle").textContent=dpYear+"-"+pad(dpMonth+1,2);
  var grid=$("dpGrid"); grid.innerHTML="";
  var first=new Date(dpYear, dpMonth, 1);
  var startDow=first.getDay();
  var days=new Date(dpYear, dpMonth+1, 0).getDate();

  for(var i=0;i<startDow;i++){
    var blank=document.createElement("div");
    blank.style.padding="10px 0";
    grid.appendChild(blank);
  }
  for(var day=1; day<=days; day++){
    (function(dayVal){
      var b=document.createElement("button");
      b.type="button";
      b.className="btn";
      b.style.padding="10px 0";
      b.style.background="#0c1324";
      b.style.borderColor="#33456f";
      b.textContent=String(dayVal);
      b.onclick=function(){
        if(dpTargetId) $(dpTargetId).value=dpFmt(dpYear, dpMonth, dayVal);
        dpClose();

        if(dpTargetId==="in_date"){
          ensureDraftOnFirstInput();
          if(!shipDueManual) recalcShipDue();
        }
        if(dpTargetId==="ship_due_date"){
          ensureDraftOnFirstInput();
          // âœ… æ‰‹å‹•é¸åˆ°é è¨‚å‡ºè²¨æ—¥æœŸ -> é€²å…¥æ‰‹å‹•æ¨¡å¼
          shipDueManual = true;
          setShipMode();
          toast("å·²æ”¹ç‚ºæ‰‹å‹•é è¨‚å‡ºè²¨æ—¥æœŸ");
        }
      };
      grid.appendChild(b);
    })(day);
  }
}

$("dpPrev").onclick=function(){dpMonth--; if(dpMonth<0){dpMonth=11; dpYear--;} dpRender();};
$("dpNext").onclick=function(){dpMonth++; if(dpMonth>11){dpMonth=0; dpYear++;} dpRender();};
$("dpClose").onclick=dpClose;
$("dpClear").onclick=function(){
  if(dpTargetId) $(dpTargetId).value="";
  dpClose();

  if(dpTargetId==="in_date"){
    ensureDraftOnFirstInput();
    if(!shipDueManual) recalcShipDue();
  }
  if(dpTargetId==="ship_due_date"){
    ensureDraftOnFirstInput();
    // æ¸…ç©ºé è¨‚å‡ºè²¨æ—¥ -> å›è‡ªå‹•æ¨¡å¼
    shipDueManual = false;
    setShipMode();
    recalcShipDue();
    toast("å·²æ¸…ç©ºé è¨‚å‡ºè²¨æ—¥æœŸä¸¦å›è‡ªå‹•");
  }
};
$("datePickerModal").onclick=function(e){ if(e.target && e.target.id==="datePickerModal") dpClose(); };

document.addEventListener("click", function(e){
  var t=e.target;
  if(t && t.getAttribute && t.getAttribute("data-date-btn")) dpOpen(t.getAttribute("data-date-btn"));
});

$("in_date").addEventListener("click", function(){
  ensureDraftOnFirstInput();
  dpOpen("in_date");
});

$("ship_due_date").addEventListener("click", function(){
  ensureDraftOnFirstInput();
  dpOpen("ship_due_date");
});

/* =======================
   Init
======================= */
renderSidebar();
setCurrentOrderNo(null);
setShipMode();
recalcShipDue();
</script>
</body>
</html>
